\chapter{Additional Listings}

\begin{codefigure}[ht]
\lstset{firstnumber=410}
\begin{cppcode}
  Done(l) = TRUE;
}
for (cc = Local[ProcessId].mycelltab + Local[ProcessId].myncell - 1;
	cc >= Local[ProcessId].mycelltab; cc--) {
   q = *cc;
   Mass(q) = 0.0;
   Cost(q) = 0;
   CLRV(Pos(q));
   for (i = 0; i < NSUB; i++) {
	   r = Subp(q)[i];
	   if (r != NULL) {
		   while (!Done(r)) {
			   /* wait */
		   }
		   // RMS_Fence(FENCE_TYPE_LL);
		   Mass(q) += Mass(r);
		   Cost(q) += Cost(r);
		   MULVS(tmpv, Pos(r), Mass(r));
		   ADDV(Pos(q), Pos(q), tmpv);
		   Done(r) = FALSE;
	   }
   }
   DIVVS(Pos(q), Pos(q), Mass(q));
#ifdef QUADPOLE
   CLRM(Quad(q));
   for (i = 0; i < NSUB; i++) {
	   r = Subp(q)[i];
	   if (r != NULL) {
		   SUBV(dr, Pos(r), Pos(q));
		   OUTVP(drdr, dr, dr);
		   DOTVP(drsq, dr, dr);
		   SETMI(Idrsq);
		   MULMS(Idrsq, Idrsq, drsq);
		   MULMS(tmpm, drdr, 3.0);
		   SUBM(tmpm, tmpm, Idrsq);
		   MULMS(tmpm, tmpm, Mass(r));
		   ADDM(tmpm, tmpm, Quad(r));
		   ADDM(Quad(q), Quad(q), tmpm);
	   }
   }
#endif
   // RMS_Fence(FENCE_TYPE_SS);
   Done(q) = TRUE;
\end{cppcode}
\caption{Barnes: The racy accesses to \icode{r->done} (\icode{load.C}).}
\label{code:barnes_loadc}
\end{codefigure}
